from flask import Flask, render_template,request,session,redirect
import sqlite3 as sql

app = Flask(__name__)
app.secret_key = '&%82$abcABC2425262728!@$%¨&*('

@app.route('/', methods=['POST', 'GET'])
def index():
    if 'username' in session:
        user = session['username']
        return render_template('index.html',ms = 1,level=2)
    else:        return render_template('index.html',level=0)

@app.route('/cadastro/', methods=['POST', 'GET'])
def cadastro():
    if request.method == 'POST':
        username = request.form['log']
        pass1 = request.form['pass']
        pass2 = request.form['pass2']
        if len(username)>16 or len(username)<4:
            return render_template('cadastro.html',msg=1,war="O usuário deve conter de 4 a 16 caracteres")
        elif pass1 != pass2:
            return render_template('cadastro.html',msg=1,war="As senhas não são as mesmas!")              
        elif not username.isalpha():	
            return render_template('cadastro.html',msg=1,war="O nome do usuário deve possuir apenas caracteres alfa-numéricos")
        else:
            con=sql.connect('data/login.db')
            cur=con.cursor()
            cur.execute("SELECT * FROM login WHERE login = ?", (username,))
            userdata=cur.fetchone()
            if userdata == None:
                cur.execute("INSERT INTO login (login, password) VALUES (?,?)", (username,pass1))
                con.commit()
                con.close()
                return render_template('cadastro.html',msg=2,war="Cadastro realizado com sucesso")
            else:
                return render_template('cadastro.html',msg=1,war="Usuário já utilizado")

    else:
        return render_template('cadastro.html',msg=0)
	
@app.route('/login/', methods=['POST', 'GET'])
def login():
    if request.method == 'POST':
        user = request.form['name']
        pswd = request.form['pswd']
        con = sql.connect('data/login.db')
        cur = con.cursor()
        cur.execute("SELECT * FROM login WHERE login = ?", (user,))
        userdata1 = cur.fetchone()

        if userdata1 == None:
            return render_template('login.html',ms = 2,warning = 'Usuarário não cadastrado!')
        else:
            if pswd != userdata1[1]:
                return render_template('login.html',ms = 2,warning = 'Senha digitada incorreta!')
            else:
                session['username'] = user
                return render_template('login.html',ms = 1,warning = 'Usuário conectado')
    else:
        if 'username' in session:
            user = session['username']
            return render_template('index.html',ms = 1,level=2)
        
        else:
            return render_template('login.html',ms = 0,warning = 'Usuário conectado')


@app.route('/projeto/', methods=['POST', 'GET'])
def projeto():
    
    return render_template('projeto.html')
@app.route('/')
def logout():
    session.pop('username', None)
    redirect('/login/')
if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0')
